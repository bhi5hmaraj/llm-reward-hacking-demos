// Warden's Dilemma Database Schema
//
// This schema defines the persistent storage for experiments, game sessions,
// round history, and chat logs.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Management
// ============================================================================

/// Experimenters who create and manage experiments
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String   // Hashed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  experiments Experiment[]

  @@map("users")
}

// ============================================================================
// Experiments
// ============================================================================

/// An experiment configuration and its runtime state
model Experiment {
  id        String           @id @default(uuid())
  name      String
  status    ExperimentStatus @default(SETUP)

  // Configuration (stored as JSONB)
  config     Json  // ExperimentConfig type
  hypothesis Json? // Hypothesis type (optional)

  // Runtime state
  currentRound Int @default(0)

  // Relationships
  createdBy   String
  creator     User          @relation(fields: [createdBy], references: [id])
  gameSession GameSession?
  rounds      Round[]
  chatLogs    ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdBy])
  @@index([status])
  @@map("experiments")
}

enum ExperimentStatus {
  SETUP
  LOBBY
  IN_PROGRESS
  COMPLETED
  ABORTED
}

// ============================================================================
// Game Sessions
// ============================================================================

/// Active Colyseus room tracking
model GameSession {
  experimentId String     @id
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  roomId       String     @unique
  playerStates Json       // Record<PlayerId, PlayerState>

  startedAt    DateTime?
  endedAt      DateTime?

  @@map("game_sessions")
}

// ============================================================================
// Round History
// ============================================================================

/// Historical record of each round played
model Round {
  id           String     @id @default(uuid())
  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  roundNumber  Int

  // Payoff matrix for this round
  payoffMatrix Json // PayoffMatrix type

  // Actions and outcomes
  actions          Json // Record<PlayerId, PlayerAction>
  payoffs          Json // Record<PlayerId, number>
  cumulativeScores Json // Record<PlayerId, number>

  // Timestamps
  announcedAt DateTime
  revealedAt  DateTime
  durationMs  Int // Total round duration in milliseconds

  @@unique([experimentId, roundNumber])
  @@index([experimentId])
  @@map("rounds")
}

// ============================================================================
// Chat Messages
// ============================================================================

/// Private 1:1 chat messages between players
model ChatMessage {
  id           String     @id @default(uuid())
  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id], onDelete: Cascade)

  roundNumber  Int
  fromPlayer   String
  toPlayer     String
  content      String     @db.Text
  timestamp    DateTime   @default(now())

  @@index([experimentId, roundNumber])
  @@index([fromPlayer, toPlayer])
  @@map("chat_messages")
}
